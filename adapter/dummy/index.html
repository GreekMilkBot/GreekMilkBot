<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>测试平台</title>
    <script src="./index.js"></script>
    <link rel="stylesheet" href="./index.css">
</head>
<body>
<!-- 会话列表区域 -->
<div class="chat-list" id="chatList">
    <div class="chat-list-header">
        <h2>会话列表</h2>
    </div>
    <div class="chat-items" id="chatItems">
    </div>
</div>

<!-- 聊天区域 -->
<div class="chat-container" id="chatContainer">
    <div class="chat-header">
        <div class="back-button" id="backButton">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M15 19L9 12L15 5" stroke="#333" stroke-width="2" stroke-linecap="round"
                      stroke-linejoin="round"></path>
            </svg>
        </div>
        <div class="current-chat-name" id="currentChatName">张三</div>
    </div>
    <div class="chat-messages" id="chatMessages"></div>
    <div class="chat-input-area">
        <div id="referencedMessageContainer"></div>
        <div class="attachments-container" id="attachmentsContainer"></div>
        <div class="chat-input-container">
            <label for="chatInput"></label><textarea class="chat-input" placeholder="输入消息..."
                                                     id="chatInput"></textarea>
            <button class="send-button" id="sendButton" onclick="sendMessage()">
                <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="none" viewBox="0 0 24 24">
                    <path fill="currentColor"
                          d="m3.543 8.883 7.042-7.047a2 2 0 0 1 2.828 0l7.043 7.046a1 1 0 0 1 0 1.415l-.701.701a1 1 0 0 1-1.414 0L13.3 5.956v15.792a1 1 0 0 1-1 1h-.99a1 1 0 0 1-1-1V6.342l-4.654 4.656a1 1 0 0 1-1.414 0l-.7-.7a1 1 0 0 1 0-1.415"></path>
                </svg>
            </button>
        </div>
        <!-- @用户下拉列表 -->
        <div class="mention-dropdown" id="mentionDropdown"></div>
    </div>
</div>

<script>
    const params = new URLSearchParams(window.location.search);
    let selectID = params.get("select")
    if (selectID == null || selectID === "") {
        const findGroups = getSessions();
        selectID = findGroups[0].id
    }
    const selfStatus = selfInfo()

    const chatItems = document.getElementById('chatItems');
    const currentChatName = document.getElementById('currentChatName');
    const chatMessages = document.getElementById('chatMessages');
    const chatInput = document.getElementById('chatInput');
    const chatList = document.getElementById('chatList');
    const chatContainer = document.getElementById('chatContainer');
    const backButton = document.getElementById('backButton');
    const mentionDropdown = document.getElementById('mentionDropdown');
    const attachmentsContainer = document.getElementById('attachmentsContainer');
    const referencedMessageContainer = document.getElementById('referencedMessageContainer');


    function refreshSession() {
        chatItems.innerHTML = ""
        getSessions().forEach(group => {
            const child = document.createElement('div');
            child.classList.add('chat-item');
            child.onclick = function () {
                selectID = group.id;
                refreshSession()
            }
            child.id = "session-" + group.id
            child.attributes["data-chat-id"] = group.id;
            if (selectID === group.id) {
                child.classList.add('active');
                refreshMessage(group.id)
                history.replaceState(null, null, '?select=' + group.id);
            }
            const lastMsg = getLastMessage(group.id);
            if (group.type === "group") {
                const groupInfo = getGroupInfo(group.target);
                if (selectID === group.id) {
                    currentChatName.textContent = `${groupInfo.name} (${groupInfo.users.length})`;
                }
                child.innerHTML = `
            <div class="avatar">
                <img src="${groupInfo.image}" alt="用户头像">
            </div>
            <div class="chat-info">
                <div class="chat-info-header">
                    <div class="chat-name">${groupInfo.name}<span>(群组)</span></div>
                    <div class="chat-time">${timeFormat(lastMsg.time)}</div>
                </div>
                <div class="chat-message">${selfStatus.id !== lastMsg.sender ? getUserInfo(lastMsg.sender).name + ":" : ""}${lastMsg.content}</div>
        </div>`
            } else {
                const userInfo = getUserInfo(group.target);
                if (selectID === group.id) {
                    currentChatName.textContent = userInfo.name;
                }
                child.innerHTML = `
            <div class="avatar">
                <img src="${userInfo.image}" alt="用户头像">
            </div>
            <div class="chat-info">
                <div class="chat-info-header">
                    <div class="chat-name">${userInfo.name}</div>
                    <div class="chat-time">${timeFormat(lastMsg.time)}</div>
                </div>
                <div class="chat-message">${lastMsg.content}</div>
        </div>`
            }
            chatItems.appendChild(child);
        })
        if (window.innerWidth < 768) {
            chatList.classList.remove('active');
            chatContainer.classList.remove('hidden');
        }
    }


    function refreshMessage(activeID) {
        chatMessages.innerHTML = '';
        // 添加消息到聊天区域
        getMessages(activeID).forEach(msg => {
            const messageDiv = document.createElement('div');
            messageDiv.style.position = 'relative';
            messageDiv.className = `message ${msg.sender === selfStatus.id ? 'sent' : 'received'}`;
            const statUserInfo = getUserInfo(msg.sender)
            messageDiv.innerHTML = `
                <div class="avatar"><img src="${statUserInfo.image}" alt="用户头像"></div>
                <div class="message-group">
                <div class="message-content">${msg.content}</div>
                <div class="message-time">${timeFormat(msg.time)}</div>
</div>
<div class="reference-icon">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M10 9V5l-7 7 7 7v-4.1c5 0 8.5 1.6 11 5.1-1-5-4-10-11-11z" fill="#888"/>
            </svg>
          </div>
                `;

            chatMessages.appendChild(messageDiv);
            const referenceIcon = messageDiv.querySelector('.reference-icon');
            referenceIcon.addEventListener('click', () => {
                setReferencedMessage(msg);
            });
        });

        // 滚动到底部
        chatMessages.scrollTop = chatMessages.scrollHeight;
        chatInput.value = ''
    }

    refreshSession()

    // 发送消息
    function sendMessage() {
        const messageContent = chatInput.value.trim();
        if (messageContent === '') return;

        const newMessage = {
            sender: selfStatus.id,
            content: messageContent,
            time: new Date().toISOString(),
        };

        pushMessage(selectID, newMessage);

        // 清空输入框
        chatInput.value = '';
        refreshMessage(selectID)
        refreshSession()
    }

    // 按Enter发送消息
    chatInput.addEventListener('keydown', (e) => {
        // 按Enter发送消息
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }

        // ESC键隐藏@用户下拉列表
        if (e.key === "Escape") {
            e.preventDefault();
            mentionDropdown.style.display = "none";
        }
    });
    chatInput.addEventListener('keyup', (e) => {
        if (e.key === 'Backspace') {
            const text = chatInput.value;
            const lastAtIndex = text.lastIndexOf('@', chatInput.selectionStart - 1);
            if (lastAtIndex >= 0 && !(text.substring(lastAtIndex, text.length).includes(' '))) {
                mentionDropdown.style.display = "none";
                chatInput.value = text.substring(0, lastAtIndex);
            }
        }
    })
    chatInput.addEventListener('paste', (e) => {
        // 检查是否有剪贴板数据
        if (e.clipboardData && e.clipboardData.items) {
            // 遍历所有剪贴板项目
            for (let i = 0; i < e.clipboardData.items.length; i++) {
                const item = e.clipboardData.items[i];

                // 检查项目是否为图片
                if (item.type.indexOf('image') !== -1) {
                    const blob = item.getAsFile();
                    const reader = new FileReader();
                    // 读取图片为Base64格式
                    reader.onload = function (event) {
                        // 创建图片元素
                        const imageUrl = event.target.result;
                        addImagePreview(imageUrl);
                    };
                    reader.readAsDataURL(blob);
                    e.preventDefault();
                }
            }
        }
    })

    // 添加图片预览
    function addImagePreview(imageUrl) {
        const previewContainer = document.createElement('div');
        previewContainer.className = 'attachment-preview';
        previewContainer.dataset.imageUrl = imageUrl;

        const imageElement = document.createElement('img');
        imageElement.src = imageUrl;

        const removeButton = document.createElement('div');
        removeButton.className = 'remove-attachment';
        removeButton.innerHTML = '×';
        removeButton.addEventListener('click', () => {
            // 从DOM中移除
            previewContainer.remove();
            // pastedImages = pastedImages.filter(url => url !== imageUrl);
        });

        previewContainer.appendChild(imageElement);
        previewContainer.appendChild(removeButton);
        attachmentsContainer.appendChild(previewContainer);
    }

    // 设置引用的消息
    function setReferencedMessage(message) {
        // currentReferencedMessage = message;

        // 创建引用消息元素
        const referencedMessageDiv = document.createElement('div');
        referencedMessageDiv.className = 'referenced-message';
        referencedMessageDiv.innerHTML = `
        <div class="referenced-message-header">
          <div class="referenced-message-sender">${getUserInfo(message.sender).name}</div>
          <div class="referenced-message-time">${timeFormat(message.time)}</div>
          <div class="remove-reference">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z" fill="#888"/>
            </svg>
          </div>
        </div>
        <div class="referenced-message-content">${message.content}</div>
      `;

        // 清空引用消息容器并添加新的引用消息
        referencedMessageContainer.innerHTML = '';
        referencedMessageContainer.appendChild(referencedMessageDiv);

        // 添加移除引用事件
        const removeReference = referencedMessageDiv.querySelector('.remove-reference');
        removeReference.addEventListener('click', function () {
            referencedMessageContainer.innerHTML = '';
        });

        // 聚焦输入框
        chatInput.focus();
    }

    // 移动设备上的返回按钮
    backButton.addEventListener('click', () => {
        if (window.innerWidth < 768) {
            chatList.classList.add('active');
            chatContainer.classList.add('hidden');
        }
    });

    // 初始化页面加载时的聊天内容
    document.addEventListener('DOMContentLoaded', () => {
        if (window.innerWidth < 768) {
            chatList.classList.add('active');
            chatContainer.classList.add('hidden');
        }
    });

    let currentMention = {
        start: -1,
        end: -1,
        query: ''
    };

    // 处理@用户逻辑
    function handleMention(text, cursorPos) {
        // 查找最后一个@符号的位置
        const lastAtIndex = text.lastIndexOf('@', cursorPos - 1);

        // 如果没有找到@符号，或者@符号不是单词的开始（前面有非空白字符）
        if (lastAtIndex === -1 || (lastAtIndex > 0 && /\S/.test(text[lastAtIndex - 1]))) {
            mentionDropdown.style.display = 'none';
            currentMention = {start: -1, end: -1, query: ''};
            return;
        }

        // 获取@之后的文本作为查询
        const query = text.substring(lastAtIndex + 1, cursorPos);


        // 过滤匹配的用户
        const matchedUsers = searchUser(selectID, query.toLowerCase())
        // 如果没有匹配的用户，不显示下拉列表
        if (matchedUsers.length === 0) {
            mentionDropdown.style.display = 'none';
            currentMention = {start: -1, end: -1, query: ''};
            return;
        }

        // 更新当前@的位置和内容
        currentMention = {
            start: lastAtIndex,
            end: cursorPos,
            query: query
        };

        // 显示下拉列表
        renderMentionDropdown(matchedUsers);
        mentionDropdown.style.display = 'block';
    }

    // 渲染@用户下拉列表
    function renderMentionDropdown(users) {
        mentionDropdown.innerHTML = '';
        users.forEach(user => {
            const userItem = document.createElement('div');
            userItem.className = 'mention-item';
            userItem.innerHTML = `
          <div class="avatar">
            <img src="${user.image}" alt="${user.name}">
          </div>
          <div class="name">${user.name}</div>
          <div class="id">(<span class="sid">${user.id}</span>)</div>

        `;

            userItem.addEventListener('click', () => {
                insertMention(user);
            });
            mentionDropdown.appendChild(userItem);
        });
    }

    // 插入@用户
    function insertMention(user) {
        const text = chatInput.value;
        const mentionText = `@${user.id} `;

        // 替换@查询为完整的@格式
        // 设置新的文本
        chatInput.value = text.substring(0, currentMention.start) +
            mentionText +
            text.substring(currentMention.end);

        // 移动光标到插入内容之后
        const newCursorPos = currentMention.start + mentionText.length;
        chatInput.focus();
        chatInput.setSelectionRange(newCursorPos, newCursorPos);

        // 隐藏下拉列表
        mentionDropdown.style.display = 'none';
    }


    // 输入框内容变化时处理@用户
    chatInput.addEventListener('input', () => {
        const cursorPos = chatInput.selectionStart;
        handleMention(chatInput.value, cursorPos);
    });

    // 输入框聚焦时检查是否需要显示@用户下拉列表
    chatInput.addEventListener('focus', () => {
        const cursorPos = chatInput.selectionStart;
        handleMention(chatInput.value, cursorPos);
    });
    // 点击其他区域隐藏@用户下拉列表
    document.addEventListener("click", (e) => {
        if (
            !chatInput.contains(e.target) &&
            !mentionDropdown.contains(e.target)
        ) {
            mentionDropdown.style.display = "none";
        }
    });

    window.addEventListener('resize', () => {
        if (window.innerWidth >= 768) {
            chatList.classList.remove('active');
            chatContainer.classList.remove('hidden');
        } else if (!chatContainer.classList.contains('hidden')) {
            chatList.classList.remove('active');
        } else {
            chatList.classList.add('active');
        }
    });
</script>
</body>
</html>